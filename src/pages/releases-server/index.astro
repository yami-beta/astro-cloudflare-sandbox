---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";

// Server Outputï¼ˆSSRï¼‰ã‚’æœ‰åŠ¹åŒ–
export const prerender = false;

// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
const url = new URL(Astro.request.url);
const categoryFilter = url.searchParams.get("category");
const sortOrder = url.searchParams.get("sort") || "desc";

// ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ï¼ˆæœªå…¬é–‹ãƒªãƒªãƒ¼ã‚¹ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨ï¼‰
const now = new Date();

// Content Collectionsã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’å–å¾—
let allReleases = await getCollection("releases");

// æœªå…¬é–‹ãƒªãƒªãƒ¼ã‚¹ï¼ˆæœªæ¥ã®æ—¥ä»˜ï¼‰ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
let releases = allReleases.filter((release) => release.data.date <= now);

// ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸæœªå…¬é–‹ãƒªãƒªãƒ¼ã‚¹ã®æ•°ã‚’è¨ˆç®—
const unpublishedCount = allReleases.length - releases.length;

// ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
if (categoryFilter) {
  releases = releases.filter(
    (release) => release.data.category === categoryFilter,
  );
}

// ã‚½ãƒ¼ãƒˆå‡¦ç†
const sortedReleases = releases.sort((a, b) => {
  const result = b.data.date.getTime() - a.data.date.getTime();
  return sortOrder === "asc" ? -result : result;
});

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚åˆ»ã‚’å–å¾—ï¼ˆå‹•çš„ç”Ÿæˆã®è¨¼æ˜ï¼‰
const requestTime = new Date().toLocaleString("ja-JP", {
  timeZone: "Asia/Tokyo",
  year: "numeric",
  month: "2-digit",
  day: "2-digit",
  hour: "2-digit",
  minute: "2-digit",
  second: "2-digit",
});

// ã‚¢ã‚¯ã‚»ã‚¹æ•°ï¼ˆå®Ÿéš›ã®DBã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã®ä¾‹ï¼‰
const accessCount = Math.floor(Math.random() * 1000) + 100;

function getCategoryBadgeClass(category: string) {
  switch (category) {
    case "major":
      return "badge-major";
    case "minor":
      return "badge-minor";
    case "patch":
      return "badge-patch";
    default:
      return "badge-default";
  }
}
---

<Layout>
  <main>
    <header class="page-header">
      <h1>ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆServer Outputç‰ˆï¼‰</h1>
      <p>ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³</p>
      <div class="server-info">
        <span class="info-badge">ğŸš€ SSR</span>
        <span class="info-time">ç”Ÿæˆæ™‚åˆ»: {requestTime}</span>
        <span class="info-count">ã‚¢ã‚¯ã‚»ã‚¹æ•°: {accessCount}</span>
      </div>
      {
        unpublishedCount > 0 && (
          <div class="unpublished-notice">
            <span>ğŸ“… {unpublishedCount}ä»¶ã®æœªå…¬é–‹ãƒªãƒªãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™</span>
          </div>
        )
      }
    </header>

    <nav class="breadcrumb">
      <a href="/">ãƒ›ãƒ¼ãƒ </a> / ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆServerç‰ˆï¼‰
    </nav>

    <div class="filter-section">
      <h3>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
      <div class="filter-controls">
        <div class="filter-group">
          <label>ã‚«ãƒ†ã‚´ãƒª:</label>
          <div class="filter-buttons">
            <a href="/releases-server" class={!categoryFilter ? "active" : ""}>
              ã™ã¹ã¦
            </a>
            <a
              href="/releases-server?category=major"
              class={categoryFilter === "major" ? "active" : ""}
            >
              Major
            </a>
            <a
              href="/releases-server?category=minor"
              class={categoryFilter === "minor" ? "active" : ""}
            >
              Minor
            </a>
            <a
              href="/releases-server?category=patch"
              class={categoryFilter === "patch" ? "active" : ""}
            >
              Patch
            </a>
          </div>
        </div>
        <div class="filter-group">
          <label>ä¸¦ã³é †:</label>
          <div class="filter-buttons">
            <a
              href={`/releases-server${categoryFilter ? `?category=${categoryFilter}&` : "?"}sort=desc`}
              class={sortOrder === "desc" ? "active" : ""}
            >
              æ–°ã—ã„é †
            </a>
            <a
              href={`/releases-server${categoryFilter ? `?category=${categoryFilter}&` : "?"}sort=asc`}
              class={sortOrder === "asc" ? "active" : ""}
            >
              å¤ã„é †
            </a>
          </div>
        </div>
      </div>
      {
        categoryFilter && (
          <p class="filter-status">
            ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä¸­: <strong>{categoryFilter.toUpperCase()}</strong>{" "}
            ãƒªãƒªãƒ¼ã‚¹ã®ã¿è¡¨ç¤º
          </p>
        )
      }
    </div>

    <div class="releases-grid">
      {
        sortedReleases.length > 0 ? (
          sortedReleases.map((release) => (
            <article class="release-card">
              <div class="release-header">
                <h2>
                  <a href={`/releases-server/${release.id}`}>
                    ãƒãƒ¼ã‚¸ãƒ§ãƒ³ {release.data.version}
                  </a>
                </h2>
                <div class="badges">
                  <span
                    class={`badge ${getCategoryBadgeClass(release.data.category)}`}
                  >
                    {release.data.category.toUpperCase()}
                  </span>
                  {release.data.breaking && (
                    <span class="badge badge-breaking">Breaking Change</span>
                  )}
                </div>
              </div>

              <time datetime={release.data.date.toISOString()}>
                {release.data.date.toLocaleDateString("ja-JP", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })}
              </time>

              <div class="release-summary">
                {release.data.features && release.data.features.length > 0 && (
                  <div class="summary-section">
                    <h3>âœ¨ æ–°æ©Ÿèƒ½</h3>
                    <ul>
                      {release.data.features.slice(0, 3).map((feature) => (
                        <li>{feature}</li>
                      ))}
                      {release.data.features.length > 3 && (
                        <li class="more">
                          ä»– {release.data.features.length - 3} ä»¶...
                        </li>
                      )}
                    </ul>
                  </div>
                )}

                {release.data.fixes && release.data.fixes.length > 0 && (
                  <div class="summary-section">
                    <h3>ğŸ› ä¿®æ­£</h3>
                    <ul>
                      {release.data.fixes.slice(0, 2).map((fix) => (
                        <li>{fix}</li>
                      ))}
                      {release.data.fixes.length > 2 && (
                        <li class="more">
                          ä»– {release.data.fixes.length - 2} ä»¶...
                        </li>
                      )}
                    </ul>
                  </div>
                )}
              </div>

              <a href={`/releases-server/${release.id}`} class="read-more">
                è©³ç´°ã‚’è¦‹ã‚‹ â†’
              </a>
            </article>
          ))
        ) : (
          <div class="no-results">
            <p>è©²å½“ã™ã‚‹ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
            <a href="/releases-server">ã™ã¹ã¦ã®ãƒªãƒªãƒ¼ã‚¹ã‚’è¡¨ç¤º</a>
          </div>
        )
      }
    </div>

    <section class="info-section">
      <h2>Server Output ã«ã¤ã„ã¦</h2>
      <p>
        ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ é™çš„ç”Ÿæˆç‰ˆï¼ˆ<a
          href="/releases">ã“ã¡ã‚‰</a
        >ï¼‰ã¨ã¯ç•°ãªã‚Šã€ ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™ï¼š
      </p>
      <ul>
        <li>å‹•çš„ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ï¼‰</li>
        <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºï¼ˆã‚¢ã‚¯ã‚»ã‚¹æ•°ãªã©ï¼‰</li>
        <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…ä¿¡ï¼ˆèªè¨¼é€£æºæ™‚ï¼‰</li>
        <li>å¤–éƒ¨APIã¨ã®é€£æºï¼ˆæœ€æ–°æƒ…å ±ã®å–å¾—ï¼‰</li>
      </ul>
      <div class="comparison">
        <h3>é™çš„ç”Ÿæˆç‰ˆã¨ã®æ¯”è¼ƒ</h3>
        <table>
          <thead>
            <tr>
              <th>æ©Ÿèƒ½</th>
              <th>é™çš„ç”Ÿæˆç‰ˆ</th>
              <th>Server Outputç‰ˆ</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>ç”Ÿæˆã‚¿ã‚¤ãƒŸãƒ³ã‚°</td>
              <td>ãƒ“ãƒ«ãƒ‰æ™‚</td>
              <td>ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚</td>
            </tr>
            <tr>
              <td>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</td>
              <td>é«˜é€Ÿï¼ˆCDNé…ä¿¡ï¼‰</td>
              <td>å‹•çš„ï¼ˆè¨ˆç®—ãŒå¿…è¦ï¼‰</td>
            </tr>
            <tr>
              <td>å‹•çš„æ©Ÿèƒ½</td>
              <td>ä¸å¯</td>
              <td>å¯èƒ½</td>
            </tr>
            <tr>
              <td>ã‚³ã‚¹ãƒˆ</td>
              <td>ä½ã„</td>
              <td>é«˜ã„ï¼ˆè¨ˆç®—ãƒªã‚½ãƒ¼ã‚¹ï¼‰</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</Layout>

<style>
  main {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  .page-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .page-header h1 {
    font-size: 2.5rem;
    color: #333;
    margin-bottom: 0.5rem;
  }

  .page-header p {
    color: #666;
    font-size: 1.1rem;
    margin-bottom: 1rem;
  }

  .server-info {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }

  .info-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.9rem;
    font-weight: 600;
  }

  .info-time,
  .info-count {
    background-color: #f0f0f0;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.9rem;
    color: #666;
  }

  .unpublished-notice {
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    background-color: #fff3cd;
    border: 1px solid #ffeeba;
    border-radius: 8px;
    color: #856404;
    text-align: center;
  }

  .unpublished-notice span {
    font-size: 0.9rem;
    font-weight: 500;
  }

  .breadcrumb {
    margin-bottom: 2rem;
    color: #666;
  }

  .breadcrumb a {
    color: #4f39fa;
    text-decoration: none;
  }

  .breadcrumb a:hover {
    text-decoration: underline;
  }

  .filter-section {
    background-color: #f9f9f9;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
  }

  .filter-section h3 {
    color: #333;
    margin-bottom: 1rem;
    font-size: 1.1rem;
  }

  .filter-controls {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .filter-group label {
    color: #555;
    font-weight: 500;
    min-width: 80px;
  }

  .filter-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .filter-buttons a {
    padding: 0.5rem 1rem;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    color: #666;
    text-decoration: none;
    transition: all 0.2s;
  }

  .filter-buttons a:hover {
    border-color: #4f39fa;
    color: #4f39fa;
  }

  .filter-buttons a.active {
    background-color: #4f39fa;
    color: white;
    border-color: #4f39fa;
  }

  .filter-status {
    margin-top: 1rem;
    color: #666;
    padding: 0.5rem;
    background-color: #e8f5e9;
    border-radius: 8px;
  }

  .releases-grid {
    display: grid;
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .release-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 2rem;
    transition: box-shadow 0.2s;
  }

  .release-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .release-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .release-header h2 {
    margin: 0;
    font-size: 1.5rem;
  }

  .release-header h2 a {
    color: #333;
    text-decoration: none;
  }

  .release-header h2 a:hover {
    color: #4f39fa;
  }

  .badges {
    display: flex;
    gap: 0.5rem;
  }

  .badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .badge-major {
    background-color: #ffe4e1;
    color: #d32f2f;
  }

  .badge-minor {
    background-color: #e3f2fd;
    color: #1976d2;
  }

  .badge-patch {
    background-color: #f0f0f0;
    color: #666;
  }

  .badge-breaking {
    background-color: #fff3cd;
    color: #856404;
  }

  time {
    display: block;
    color: #666;
    margin-bottom: 1rem;
  }

  .release-summary {
    margin: 1.5rem 0;
  }

  .summary-section {
    margin-bottom: 1rem;
  }

  .summary-section h3 {
    font-size: 1rem;
    color: #555;
    margin-bottom: 0.5rem;
  }

  .summary-section ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .summary-section li {
    padding: 0.25rem 0;
    padding-left: 1rem;
    color: #666;
    position: relative;
  }

  .summary-section li::before {
    content: "â€¢";
    position: absolute;
    left: 0;
  }

  .summary-section li.more {
    font-style: italic;
    color: #999;
  }

  .read-more {
    display: inline-block;
    color: #4f39fa;
    text-decoration: none;
    font-weight: 500;
    margin-top: 1rem;
  }

  .read-more:hover {
    text-decoration: underline;
  }

  .no-results {
    text-align: center;
    padding: 3rem;
    background-color: #f9f9f9;
    border-radius: 12px;
  }

  .no-results p {
    color: #666;
    margin-bottom: 1rem;
  }

  .no-results a {
    color: #4f39fa;
    text-decoration: none;
  }

  .no-results a:hover {
    text-decoration: underline;
  }

  .info-section {
    background-color: #f9f9f9;
    padding: 2rem;
    border-radius: 12px;
  }

  .info-section h2 {
    color: #333;
    margin-bottom: 1rem;
  }

  .info-section h3 {
    color: #555;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
  }

  .info-section p {
    color: #666;
    margin-bottom: 1rem;
    line-height: 1.6;
  }

  .info-section ul {
    list-style-position: inside;
    color: #666;
    line-height: 1.8;
  }

  .info-section a {
    color: #4f39fa;
    text-decoration: none;
  }

  .info-section a:hover {
    text-decoration: underline;
  }

  .comparison {
    margin-top: 2rem;
  }

  .comparison table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }

  .comparison th,
  .comparison td {
    padding: 0.75rem;
    text-align: left;
    border: 1px solid #e0e0e0;
  }

  .comparison th {
    background-color: #f0f0f0;
    font-weight: 600;
    color: #333;
  }

  .comparison td {
    background-color: white;
    color: #666;
  }

  code {
    background-color: #f0f0f0;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9rem;
  }

  @media (max-width: 768px) {
    .release-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .filter-group {
      flex-direction: column;
      align-items: flex-start;
    }

    .comparison {
      overflow-x: auto;
    }

    .comparison table {
      min-width: 500px;
    }
  }
</style>
